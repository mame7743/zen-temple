{%- macro calculator() -%}
<div 
    x-data="new CalculatorState()"
    class="bg-white rounded-xl shadow-lg p-6 max-w-sm mx-auto"
>
    <h3 class="text-2xl font-bold mb-4 text-gray-800">電卓 (Calculator)</h3>
    
    <!-- Display -->
    <div class="bg-gray-100 rounded-lg p-4 mb-4">
        <div 
            x-text="display" 
            class="text-right text-3xl font-mono text-gray-900 min-h-[2.5rem] break-all"
        ></div>
        <div 
            x-show="operation" 
            x-text="'操作: ' + operation"
            class="text-right text-sm text-gray-500 mt-1"
        ></div>
    </div>
    
    <!-- Calculator Buttons -->
    <div class="grid grid-cols-4 gap-2">
        <!-- Clear buttons -->
        <button 
            @click="clear()" 
            class="col-span-2 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition"
        >
            C
        </button>
        <button 
            @click="clearEntry()" 
            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-lg transition"
        >
            CE
        </button>
        <button 
            @click="inputOperation('/')" 
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition"
        >
            ÷
        </button>
        
        <!-- Number row 7-9 -->
        <button 
            @click="inputDigit('7')" 
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"
        >
            7
        </button>
        <button 
            @click="inputDigit('8')" 
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"
        >
            8
        </button>
        <button 
            @click="inputDigit('9')" 
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"
        >
            9
        </button>
        <button 
            @click="inputOperation('*')" 
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition"
        >
            ×
        </button>
        
        <!-- Number row 4-6 -->
        <button 
            @click="inputDigit('4')" 
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"
        >
            4
        </button>
        <button 
            @click="inputDigit('5')" 
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"
        >
            5
        </button>
        <button 
            @click="inputDigit('6')" 
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"
        >
            6
        </button>
        <button 
            @click="inputOperation('-')" 
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition"
        >
            −
        </button>
        
        <!-- Number row 1-3 -->
        <button 
            @click="inputDigit('1')" 
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"
        >
            1
        </button>
        <button 
            @click="inputDigit('2')" 
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"
        >
            2
        </button>
        <button 
            @click="inputDigit('3')" 
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"
        >
            3
        </button>
        <button 
            @click="inputOperation('+')" 
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition"
        >
            +
        </button>
        
        <!-- Bottom row: 0, decimal, equals -->
        <button 
            @click="inputDigit('0')" 
            class="col-span-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"
        >
            0
        </button>
        <button 
            @click="inputDecimal()" 
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"
        >
            .
        </button>
        <button 
            @click="calculate()" 
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition"
        >
            =
        </button>
    </div>
    
    <!-- History -->
    <div class="mt-4" x-show="history.length > 0">
        <div class="flex justify-between items-center mb-2">
            <h4 class="text-sm font-semibold text-gray-700">履歴 (History)</h4>
            <button 
                @click="clearHistory()" 
                class="text-xs text-red-500 hover:text-red-700"
            >
                クリア
            </button>
        </div>
        <div class="bg-gray-50 rounded-lg p-2 max-h-32 overflow-y-auto">
            <template x-for="(item, index) in history" :key="index">
                <div 
                    x-text="item" 
                    class="text-xs text-gray-600 py-1 border-b border-gray-200 last:border-0"
                ></div>
            </template>
        </div>
    </div>
</div>

<script>
/**
 * CalculatorState - Encapsulated calculator component logic
 * 
 * This class manages the frontend state and user interactions for the calculator.
 * It follows zen-temple principles:
 * - Class-based state management (not inline objects)
 * - Encapsulated methods for all operations
 * - Clean separation between logic and presentation
 */
class CalculatorState {
    constructor() {
        this.display = '0';
        this.currentValue = 0;
        this.previousValue = 0;
        this.operation = '';
        this.newNumber = true;
        this.history = [];
    }
    
    /**
     * Input a digit (0-9)
     */
    inputDigit(digit) {
        if (this.newNumber) {
            this.display = digit;
            this.newNumber = false;
        } else {
            // Avoid multiple leading zeros
            if (this.display === '0') {
                this.display = digit;
            } else {
                this.display += digit;
            }
        }
    }
    
    /**
     * Input decimal point
     */
    inputDecimal() {
        if (this.newNumber) {
            this.display = '0.';
            this.newNumber = false;
        } else if (!this.display.includes('.')) {
            this.display += '.';
        }
    }
    
    /**
     * Input an operation (+, -, *, /)
     */
    inputOperation(op) {
        // If there's a pending operation, calculate it first
        if (this.operation && !this.newNumber) {
            this.calculate();
        }
        
        this.previousValue = parseFloat(this.display);
        this.operation = op;
        this.newNumber = true;
    }
    
    /**
     * Calculate the result
     */
    calculate() {
        if (!this.operation) {
            return;
        }
        
        this.currentValue = parseFloat(this.display);
        let result;
        
        try {
            switch (this.operation) {
                case '+':
                    result = this.previousValue + this.currentValue;
                    break;
                case '-':
                    result = this.previousValue - this.currentValue;
                    break;
                case '*':
                    result = this.previousValue * this.currentValue;
                    break;
                case '/':
                    if (this.currentValue === 0) {
                        this.display = 'Error';
                        this.operation = '';
                        this.newNumber = true;
                        return;
                    }
                    result = this.previousValue / this.currentValue;
                    break;
                default:
                    return;
            }
            
            // Format result
            if (result === Math.floor(result)) {
                this.display = result.toString();
            } else {
                this.display = result.toFixed(8).replace(/\.?0+$/, '');
            }
            
            // Add to history
            const operationStr = `${this.previousValue} ${this.operation} ${this.currentValue} = ${result}`;
            this.history.push(operationStr);
            
            // Reset state
            this.operation = '';
            this.newNumber = true;
            
        } catch (e) {
            this.display = 'Error';
            this.operation = '';
            this.newNumber = true;
        }
    }
    
    /**
     * Clear calculator (reset to initial state)
     */
    clear() {
        this.display = '0';
        this.currentValue = 0;
        this.previousValue = 0;
        this.operation = '';
        this.newNumber = true;
    }
    
    /**
     * Clear current entry only
     */
    clearEntry() {
        this.display = '0';
        this.newNumber = true;
    }
    
    /**
     * Clear calculation history
     */
    clearHistory() {
        this.history = [];
    }
}
</script>
{%- endmacro -%}
